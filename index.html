<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>MyCloudText â€” Secure</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  /* Custom Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  .dark ::-webkit-scrollbar-thumb { background: #475569; }
  .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  [x-cloak] { display: none !important; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 h-screen flex flex-col overflow-hidden">

<!-- TOAST CONTAINER -->
<div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>

<!-- ADMIN LOGIN MODAL (Hidden by default) -->
<div id="login-modal" class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden">
  <div class="bg-white dark:bg-gray-800 w-full max-w-sm p-6 rounded-2xl shadow-2xl transform transition-all scale-100">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Admin Access</h2>
      <button onclick="closeLogin()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
    </div>
    <p class="text-sm text-gray-500 mb-4">Enter the master password to view saved notes.</p>
    <input type="password" id="admin-password" placeholder="Password" 
      class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
      onkeyup="if(event.key==='Enter') attemptAdminLogin()">
    <button onclick="attemptAdminLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
      Unlock Vault
    </button>
  </div>
</div>

<!-- HEADER -->
<header class="h-16 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 shrink-0 shadow-sm z-20">
  <div class="font-bold text-lg tracking-tight flex items-center gap-2">
    <i class="fa-solid fa-cloud text-blue-500"></i> <span class="hidden md:inline">MyCloudText</span>
    <span id="mode-badge" class="bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full text-gray-500">Guest Mode</span>
  </div>
  <div class="flex items-center gap-3">
    <!-- Admin Toggle -->
    <button onclick="openLogin()" id="lock-btn" class="p-2 text-gray-400 hover:text-blue-600 transition-colors" title="Admin Login">
      <i class="fa-solid fa-lock"></i>
    </button>
    <!-- Theme Toggle -->
    <button onclick="toggleTheme()" class="p-2 text-gray-400 hover:text-yellow-500 transition-colors">
      <i class="fa-solid fa-circle-half-stroke"></i>
    </button>
  </div>
</header>

<div class="flex-1 flex overflow-hidden relative">

  <!-- SIDEBAR (Only visible to Admin) -->
  <aside id="sidebar" class="w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-col z-10 hidden md:flex">
    <div class="p-3 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
      <span class="text-xs font-bold text-gray-400 uppercase">Saved Notes</span>
      <button onclick="refreshNotes()" class="text-gray-400 hover:text-blue-500"><i class="fa-solid fa-rotate-right"></i></button>
    </div>
    <div id="note-list" class="flex-1 overflow-y-auto p-2 space-y-1">
      <!-- Notes injected here -->
      <div class="text-center mt-10 text-gray-400 text-sm p-4">
        <i class="fa-solid fa-lock text-2xl mb-2"></i><br>
        Log in to see notes.
      </div>
    </div>
  </aside>

  <!-- MAIN AREA -->
  <main class="flex-1 bg-gray-50 dark:bg-gray-900 flex flex-col relative">
    
    <!-- Editor Toolbar -->
    <div class="h-14 bg-white/50 dark:bg-gray-800/50 backdrop-blur border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 shrink-0">
      <div class="text-xs text-gray-400 font-medium uppercase tracking-wide" id="status-text">Ready to Write</div>
      <div class="flex items-center gap-2">
        <input type="file" id="file-input" multiple class="hidden" onchange="handleFileSelect(this)">
        <button onclick="document.getElementById('file-input').click()" class="text-gray-500 hover:text-blue-600 p-2 rounded-md transition-colors" title="Attach File">
          <i class="fa-solid fa-paperclip"></i>
        </button>
        <button onclick="saveNote()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-1.5 rounded shadow-sm hover:shadow transition-all flex items-center gap-2">
          <span>Save Note</span>
          <i class="fa-solid fa-paper-plane text-xs"></i>
        </button>
        <!-- Delete only for Admin -->
        <button id="delete-btn" onclick="deleteNote()" class="hidden text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-2 rounded ml-1">
          <i class="fa-regular fa-trash-can"></i>
        </button>
      </div>
    </div>

    <!-- Inputs -->
    <div class="flex-1 overflow-y-auto p-4 md:p-8">
      <div class="max-w-3xl mx-auto h-full flex flex-col">
        <input id="note-title" type="text" placeholder="Title (Optional)" 
          class="bg-transparent text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100 placeholder-gray-300 dark:placeholder-gray-600 border-none focus:ring-0 p-0 mb-4 w-full outline-none">
        
        <textarea id="note-body" placeholder="Write your note here..." 
          class="flex-1 bg-transparent resize-none text-gray-600 dark:text-gray-300 text-lg leading-relaxed border-none focus:ring-0 p-0 w-full outline-none"></textarea>
        
        <!-- Attachments -->
        <div id="attachments-area" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 min-h-[60px]">
          <div id="file-list" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
/* ---------------- CONFIG ---------------- */
// To allow Guests to encrypt notes that YOU can read, the app needs to know 
// the encryption key. We hide the password here so it works automatically.
// Guests write -> Encrypts with 'letmesee2007' -> Saves -> Only you can Decrypt.
const SHARED_SECRET = "letmesee2007"; 

/* ---------------- CRYPTO ---------------- */
const enc = new TextEncoder();
const dec = new TextDecoder();

async function deriveKey(password, saltB64) {
  const salt = Uint8Array.from(atob(saltB64), c => c.charCodeAt(0));
  const keyMat = await crypto.subtle.importKey("raw", enc.encode(password), {name:"PBKDF2"}, false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
    keyMat, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
  );
}

async function encryptData(dataStr, key) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const buf = enc.encode(dataStr);
  const ct = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, buf);
  return { iv: btoa(String.fromCharCode(...iv)), data: btoa(String.fromCharCode(...new Uint8Array(ct))) };
}

async function decryptData(b64Data, b64Iv, key) {
  const iv = Uint8Array.from(atob(b64Iv), c => c.charCodeAt(0));
  const ct = Uint8Array.from(atob(b64Data), c => c.charCodeAt(0));
  const pt = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, ct);
  return dec.decode(pt);
}

async function encryptFile(arrayBuf, key) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, arrayBuf);
  return { iv: btoa(String.fromCharCode(...iv)), data: btoa(String.fromCharCode(...new Uint8Array(ct))) };
}

async function decryptFile(b64Data, b64Iv, key) {
  const iv = Uint8Array.from(atob(b64Iv), c => c.charCodeAt(0));
  const ct = Uint8Array.from(atob(b64Data), c => c.charCodeAt(0));
  return crypto.subtle.decrypt({name:"AES-GCM", iv}, key, ct);
}

/* ---------------- STATE ---------------- */
const STATE = {
  isAdmin: false,
  notes: [],
  currentNote: null,
  pendingFiles: []
};

/* ---------------- AUTH & UI LOGIC ---------------- */
function openLogin() { document.getElementById('login-modal').classList.remove('hidden'); document.getElementById('admin-password').focus(); }
function closeLogin() { document.getElementById('login-modal').classList.add('hidden'); }

function attemptAdminLogin() {
  const input = document.getElementById('admin-password').value;
  if (input === SHARED_SECRET) {
    STATE.isAdmin = true;
    closeLogin();
    enableAdminMode();
    showToast("Welcome back, Admin!", "success");
  } else {
    showToast("Wrong Password!", "error");
    document.getElementById('admin-password').value = "";
  }
}

function enableAdminMode() {
  document.getElementById('mode-badge').innerText = "Admin Mode";
  document.getElementById('mode-badge').className = "bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full";
  document.getElementById('lock-btn').classList.add('hidden'); // Hide lock
  document.getElementById('delete-btn').classList.remove('hidden'); // Show delete
  
  // Show Sidebar
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.remove('hidden');
  
  refreshNotes();
}

function resetEditor() {
  STATE.currentNote = null;
  STATE.pendingFiles = [];
  document.getElementById('note-title').value = "";
  document.getElementById('note-body').value = "";
  renderFiles();
  document.getElementById('status-text').innerText = "New Note";
}

/* ---------------- NOTES LOGIC ---------------- */

// 1. Refresh List (Admin Only)
async function refreshNotes() {
  if (!STATE.isAdmin) return;
  document.getElementById('note-list').innerHTML = `<div class="text-center mt-10"><div class="loader mx-auto"></div></div>`;
  
  try {
    const r = await fetch('/api/notes');
    const d = await r.json();
    STATE.notes = d.notes || [];
    renderNoteList();
  } catch(e) { showToast("Failed to load notes", "error"); }
}

function renderNoteList() {
  const el = document.getElementById('note-list');
  el.innerHTML = "";
  if (STATE.notes.length === 0) {
    el.innerHTML = `<div class="text-center mt-10 text-gray-400 text-sm">No notes found.</div>`;
    return;
  }
  
  STATE.notes.forEach(n => {
    const div = document.createElement('div');
    const dateStr = new Date(n.created_at).toLocaleDateString();
    div.className = "p-3 border-b border-gray-100 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors";
    div.innerHTML = `
      <div class="font-semibold text-sm truncate text-gray-800 dark:text-gray-200">${escapeHtml(n.title||"Untitled")}</div>
      <div class="text-xs text-gray-400">${dateStr}</div>
    `;
    div.onclick = () => loadNote(n.id);
    el.appendChild(div);
  });
}

// 2. Load Note (Admin Only)
async function loadNote(id) {
  if(!STATE.isAdmin) return;
  document.getElementById('status-text').innerText = "Decrypting...";
  
  try {
    const r = await fetch(`/api/notes/${id}`);
    const note = await r.json();

    // Decrypt using SHARED_SECRET
    const key = await deriveKey(SHARED_SECRET, note.salt);
    const bodyStr = await decryptData(note.data, note.iv, key);
    const bodyObj = JSON.parse(bodyStr);

    STATE.currentNote = note;
    STATE.currentNote.files = note.files || [];
    STATE.pendingFiles = [];

    document.getElementById('note-title').value = note.title;
    document.getElementById('note-body').value = bodyObj.text || "";
    renderFiles();
    document.getElementById('status-text').innerText = "Editing: " + (note.title || "Untitled");
  } catch(e) {
    console.error(e);
    showToast("Decryption Error", "error");
  }
}

// 3. Save Note (Guests & Admin)
async function saveNote() {
  const title = document.getElementById('note-title').value.trim() || "Untitled";
  const body = document.getElementById('note-body').value;
  
  // Visual Feedback
  const saveBtn = document.querySelector('button[onclick="saveNote()"]');
  const originalHtml = saveBtn.innerHTML;
  saveBtn.innerHTML = `<div class="loader border-t-white w-4 h-4"></div> Saving...`;
  saveBtn.disabled = true;

  try {
    // ALWAYS encrypt with SHARED_SECRET so Admin can read it
    const s = crypto.getRandomValues(new Uint8Array(16));
    const saltB64 = btoa(String.fromCharCode(...s));
    
    // Note: If editing existing, we could reuse salt, but generating new is safer/easier
    // However, if we are Guest, we just make a new note.
    const key = await deriveKey(SHARED_SECRET, saltB64);
    
    // Encrypt Body
    const contentPayload = JSON.stringify({ text: body });
    const encContent = await encryptData(contentPayload, key);

    // Encrypt Files
    const filesToUpload = [];
    for (const pf of STATE.pendingFiles) {
      const encF = await encryptFile(pf.raw, key);
      filesToUpload.push({ filename: pf.filename, data: encF.data, iv: encF.iv });
    }

    const reqBody = {
      id: STATE.currentNote ? STATE.currentNote.id : null, // Only admin sets ID (editing)
      title: title,
      salt: saltB64,
      iv: encContent.iv,
      data: encContent.data,
      files: filesToUpload
    };

    const r = await fetch('/api/notes', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(reqBody)
    });
    const res = await r.json();

    if (res.ok) {
      showToast("Note Saved Securely!", "success");
      if (STATE.isAdmin) {
        refreshNotes(); // Update list
      } else {
        // Guest: Reset form completely so they can write another
        resetEditor();
      }
    } else {
      throw new Error(res.error);
    }
  } catch(e) {
    showToast("Save Failed: " + e.message, "error");
  } finally {
    saveBtn.innerHTML = originalHtml;
    saveBtn.disabled = false;
  }
}

// 4. Delete (Admin Only)
async function deleteNote() {
  if (!STATE.currentNote || !STATE.isAdmin) return;
  if (!confirm("Permanently delete this note?")) return;
  await fetch(`/api/notes/${STATE.currentNote.id}`, {method:'DELETE'});
  resetEditor();
  refreshNotes();
  showToast("Deleted", "info");
}

/* ---------------- FILES LOGIC ---------------- */
function renderFiles() {
  const el = document.getElementById('file-list');
  el.innerHTML = "";
  
  // Helper
  const mkChip = (name, size, isPending, onClick) => {
    const d = document.createElement('div');
    d.className = `flex items-center gap-2 px-3 py-1 text-xs rounded-full border ${isPending?'bg-blue-50 border-blue-200 text-blue-700':'bg-gray-100 dark:bg-gray-700 dark:border-gray-600'}`;
    d.innerHTML = `<i class="fa-solid ${isPending?'fa-upload':'fa-file'}"></i> <span class="truncate max-w-[150px]">${escapeHtml(name)}</span>`;
    if (!isPending && STATE.isAdmin) {
      const b = document.createElement('button');
      b.className="ml-1 hover:text-blue-500";
      b.innerHTML='<i class="fa-solid fa-download"></i>';
      b.onclick=onClick;
      d.appendChild(b);
    }
    el.appendChild(d);
  };

  if (STATE.currentNote && STATE.currentNote.files) {
    STATE.currentNote.files.forEach(f => mkChip(f.filename, f.size, false, () => downloadFile(f)));
  }
  STATE.pendingFiles.forEach(f => mkChip(f.filename, f.raw.byteLength, true));
}

function handleFileSelect(input) {
  Array.from(input.files).forEach(async f => {
    if(f.size > 10*1024*1024) return showToast("File too large (>10MB)", "error");
    const buf = await f.arrayBuffer();
    STATE.pendingFiles.push({ filename: f.name, raw: buf });
    renderFiles();
  });
  input.value = "";
}

async function downloadFile(fMeta) {
  if (!STATE.isAdmin) return;
  try {
    const key = await deriveKey(SHARED_SECRET, STATE.currentNote.salt);
    const buf = await decryptFile(fMeta.data, fMeta.iv, key);
    const url = URL.createObjectURL(new Blob([buf]));
    const a = document.createElement('a'); a.href=url; a.download=fMeta.filename; a.click();
    URL.revokeObjectURL(url);
  } catch(e) { showToast("Download error", "error"); }
}

/* ---------------- UTILS ---------------- */
function showToast(msg, type='info') {
  const d = document.createElement('div');
  const c = type==='error'?'bg-red-500 text-white':type==='success'?'bg-green-500 text-white':'bg-gray-800 text-white';
  d.className = `${c} px-4 py-3 rounded shadow-lg text-sm transition-all transform translate-x-full mb-2`;
  d.innerText = msg;
  document.getElementById('toast-container').appendChild(d);
  requestAnimationFrame(()=>d.classList.remove('translate-x-full'));
  setTimeout(()=>{ d.classList.add('opacity-0'); setTimeout(()=>d.remove(),300) }, 3000);
}

function toggleTheme() { document.body.classList.toggle('dark'); }
function escapeHtml(s) { return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):s; }

</script>
</body>
</html>


