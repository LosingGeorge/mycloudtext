<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<title>MyCloudText â€” Secure</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
  .dark ::-webkit-scrollbar-thumb { background: #475569; }
  .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .break-anywhere { overflow-wrap: anywhere; word-break: break-all; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 h-screen flex flex-col overflow-hidden">

<!-- ================================================================= -->
<!-- SECURITY CONFIGURATION (YOUR KEYS ARE NOW SET)                    -->
<!-- ================================================================= -->
<script>
  const CONFIG = {
    PUBLIC_KEY: `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2nqjQh7Fx63wGaothYXH54+dM7fv/iZAMO5hbKvYGjAR37qraQjghW/qhXOrf/bPhh/ddIE14u8tUmqhE1hiODEU0+02LjRSW04BS56/WESSCqz5ueqk8DX4mGIKi3+w7q8WiR5u3MV/C+D7df79eevFN+rkXwMFhUTYfBokWqjd7Wn8S9s3TT6Ag6rW/7CWubRInwWgtMnS+cYklmAtKlWwj9CF/jFC39WyktrR8Ny6TXxL80eKAe7OYe8ZSd2kTWgqIrlWCBZ+ZSsfRNNvh3SneWTjN1/EYT0nqimweHi9tKhGhRheXm8MtCc/zpSayzRmky4ZdjsG9eT4GZS7fQIDAQAB
-----END PUBLIC KEY-----`,
    ENCRYPTED_PRIVATE_KEY: "sYuJ2UI7ybV/IadaoDR+aZvbSRLWyGcEjd16qZQaeVLmIR17LMrYb2ZAm2q9qEQK56NS6GRqp+ajdoBPHmQZLPZhvxO1NUtogIOin+PdBeyBR4TfWTKAFtKxdo3oEDzGipuxKB1HIL7Ig8h33KXmnw838sbaJqBe3nixvSffaD6wbSRS69mk4RHFFmNAzk2P7TZRq1+1NiRt1iYaB9Da/U1vVi8GookhDk+t45y2eRJBYcDtGdJXFs78U2xMczbOYzy7DYcS4JN3r8XnlHiWEvGxt8Pi1abb2F3dgsTomOIpUvOqvOsnIiFJYC/e8XckfL1VoTL8iqK6rUt+zIlLDilqsnIBhTr51uPNfZBJKZCqURWIu77iVbC8/Px/rytikpXh/KDaELEZVtBsCvndqEr9/msru4AfdYUNEJubWiYJSvuJ0Sef4fe/mcIOczcRU4JwwpUExIiiz3pSaAIvFO3QF13G9PqanK/PpGg9Bw5HHyssOJMbSwLaF4c6MNK0COpepQl1njyIyfH3yYqvam+luf7qFw5Nz9nHno6ryDNQI31trIlBs2Ih+NhP0NzkYZN98xRZuIKXntgyk0hBmXt3/3JOVl+09o8H/qa4ixDqwF5v86m+uCgsZLDeN/0c+PiQchTYl8Bkzt4v0Cshe4Z1IMWUZnWEWtO50edBK8bo2RadxQcvfrfSynjg3eOq/UiAK/W2raRiM5LQVHGNCGiwySCt3w3lNWYToZhGSy57WmfcNQtpdxjUMZf9TegafZJxqsaBcqXKlXyMToWWqsV90U5HnE1EJ3mkH70gAyLLk/QMTPaoYHUCRebI/R7PT9XDCetPRrEjCJ2+Jh4ZOj06KfxVCrARAJS45/Iuodo0gxtIQezJsVPLG4vtYiVeZNMLlvp14kjDAHZ9ACgStbLFZcaTImk1HlAzDsdBXnjgqYix/+kW5ajEV43gJqJA0YE6fX/s1GLOOkZyOF6nbLjbcJX+UJ4OAEzLszJF4bO5T31EyqO063raY3NHp8OHvBVeI7TD8UYUJeC6j/JXen/2wVpvmGmdcoIvnWmeyJnCNiHq3ac/a0pe9pP7ZMgCdEQ9FS/RZrubxHHAY6v/VW9wI4mI/N+lOeRkJ5sp4RmzO4ZoMp5IADlQ6gt7vy568XpZkAX4jbxClIgfrTWBSr4Tj9+nBVWagkjdf4ymyxjHtzKWoAfjk915hLUSZJ9rOpMYHVdn1PZovFlZZlb7z/p7fI/qHJc+9DE3JVVyuOMMQRFmH7nF/4ouukqsX2E+WVNtRpt0udQ+sbfr63QR+iospfxKRBoQPguRAFs3qe/ZE7UeoR/Hm4avT23RlAkRp/63jUyXtnr9y0+Edn05ydIh5arJI1MiDdh+CfdAv3qcsW2I3WDvvwLqrN3CzbmiXroNYDxkmE09R1sZgYTsvtuyGRpw09PDsMswPv/+7moXSE50zF1X+Xkopd5t0HezQo0JJx9215o08F/sqSGINZUTw9u5+adkVi10y0uOgT9sAGStAbb54P0+KlZZVvx03WxThUOA6k+fR+uveNDPBzv/WnCVryd3HamJ8apFMesc9Z2fDa8c2yWgQNbGl3M/HCmSG3X12nFIzcQTP4KsZz9JQ9sCtAkV4bj5I50niNTR/A==",
    PRIVATE_KEY_SALT: "0lsVUhXMCplY/6RSOqdX7w==",
    PRIVATE_KEY_IV: "GhU37eqb7/9qD2xk"
  };
</script>
<!-- ================================================================= -->

<!-- SETUP WIZARD (HIDDEN NOW) -->
<div id="setup-screen" class="fixed inset-0 z-[60] bg-gray-900 text-white flex flex-col items-center justify-center p-6 overflow-y-auto hidden">
  <!-- Code omitted for cleanliness since config is present -->
</div>

<!-- TOAST CONTAINER -->
<div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>

<!-- ADMIN LOGIN MODAL -->
<div id="login-modal" class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-center justify-center hidden">
  <div class="bg-white dark:bg-gray-800 w-full max-w-sm p-6 rounded-2xl shadow-2xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Admin Decryption</h2>
      <button onclick="closeLogin()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
    </div>
    <p class="text-sm text-gray-500 mb-4">Enter password to unlock your Private Key.</p>
    <input type="password" id="admin-password" placeholder="Password" 
      class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
      onkeyup="if(event.key==='Enter') attemptAdminLogin()">
    <button onclick="attemptAdminLogin()" id="unlock-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">
      Unlock Vault
    </button>
  </div>
</div>

<!-- MAIN APP UI -->
<header class="h-16 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 shrink-0 shadow-sm z-20">
  <div class="font-bold text-lg tracking-tight flex items-center gap-2">
    <i class="fa-solid fa-user-secret text-blue-500"></i> <span class="hidden md:inline">MyCloudText</span>
    <span id="mode-badge" class="bg-gray-200 dark:bg-gray-700 text-xs px-2 py-1 rounded-full text-gray-500">Guest (Write Only)</span>
  </div>
  <div class="flex items-center gap-3">
    <button onclick="openLogin()" id="lock-btn" class="p-2 text-gray-400 hover:text-blue-600 transition-colors" title="Admin Login">
      <i class="fa-solid fa-lock"></i>
    </button>
    <button onclick="toggleTheme()" class="p-2 text-gray-400 hover:text-yellow-500 transition-colors">
      <i class="fa-solid fa-circle-half-stroke"></i>
    </button>
  </div>
</header>

<div class="flex-1 flex overflow-hidden relative">
  <!-- SIDEBAR -->
  <aside id="sidebar" class="w-80 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex-col z-10 hidden md:flex">
    <div class="p-3 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
      <span class="text-xs font-bold text-gray-400 uppercase">Saved Notes</span>
      <button onclick="refreshNotes()" class="text-gray-400 hover:text-blue-500"><i class="fa-solid fa-rotate-right"></i></button>
    </div>
    <div id="note-list" class="flex-1 overflow-y-auto p-2 space-y-1">
      <div class="text-center mt-10 text-gray-400 text-sm p-4">
        <i class="fa-solid fa-eye-slash text-2xl mb-2"></i><br>
        Notes are encrypted.<br>Login to decrypt & read.
      </div>
    </div>
  </aside>

  <!-- EDITOR -->
  <main class="flex-1 bg-gray-50 dark:bg-gray-900 flex flex-col relative">
    <div class="h-14 bg-white/50 dark:bg-gray-800/50 backdrop-blur border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 shrink-0">
      <div class="text-xs text-gray-400 font-medium uppercase tracking-wide" id="status-text">New Encrypted Note</div>
      <div class="flex items-center gap-2">
        <input type="file" id="file-input" multiple class="hidden" onchange="handleFileSelect(this)">
        <button onclick="document.getElementById('file-input').click()" class="text-gray-500 hover:text-blue-600 p-2 rounded-md transition-colors" title="Attach File">
          <i class="fa-solid fa-paperclip"></i>
        </button>
        <button onclick="saveNote()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-1.5 rounded shadow-sm hover:shadow transition-all flex items-center gap-2">
          <span>Save Securely</span>
          <i class="fa-solid fa-lock text-xs"></i>
        </button>
        <button id="delete-btn" onclick="deleteNote()" class="hidden text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-2 rounded ml-1">
          <i class="fa-regular fa-trash-can"></i>
        </button>
      </div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 md:p-8">
      <div class="max-w-3xl mx-auto h-full flex flex-col">
        <input id="note-title" type="text" placeholder="Note Title" 
          class="bg-transparent text-2xl md:text-3xl font-bold text-gray-800 dark:text-gray-100 placeholder-gray-300 dark:placeholder-gray-600 border-none focus:ring-0 p-0 mb-4 w-full outline-none">
        <textarea id="note-body" placeholder="Write something confidential..." 
          class="flex-1 bg-transparent resize-none text-gray-600 dark:text-gray-300 text-lg leading-relaxed border-none focus:ring-0 p-0 w-full outline-none"></textarea>
        <div id="attachments-area" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 min-h-[60px]">
          <div id="file-list" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- ================================================================= -->
<!-- APPLICATION LOGIC                                                 -->
<!-- ================================================================= -->
<script>
/* --- STATE --- */
const STATE = {
  isAdmin: false,
  privateKey: null, 
  notes: [],
  currentNote: null,
  pendingFiles: []
};

/* --- CRYPTO HELPERS --- */
const enc = new TextEncoder();
const dec = new TextDecoder();

function bufToB64(buf) { return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function b64ToBuf(b64) { return Uint8Array.from(atob(b64), c => c.charCodeAt(0)); }

async function generateAesKey() {
  return crypto.subtle.generateKey({name: "AES-GCM", length: 256}, true, ["encrypt", "decrypt"]);
}

async function aesEncrypt(data, key) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const buf = typeof data === 'string' ? enc.encode(data) : data;
  const ct = await crypto.subtle.encrypt({name: "AES-GCM", iv}, key, buf);
  return { iv: bufToB64(iv), data: bufToB64(ct) };
}

async function aesDecrypt(b64Data, b64Iv, key, isText=true) {
  const iv = b64ToBuf(b64Iv);
  const ct = b64ToBuf(b64Data);
  const pt = await crypto.subtle.decrypt({name: "AES-GCM", iv}, key, ct);
  return isText ? dec.decode(pt) : pt;
}

async function importPublicKey(pem) {
  const b64 = pem.replace(/-----(BEGIN|END) PUBLIC KEY-----|\n/g, "");
  return crypto.subtle.importKey(
    "spki", b64ToBuf(b64), 
    {name: "RSA-OAEP", hash: "SHA-256"}, false, ["encrypt"]
  );
}

async function wrapKeyWithRsa(aesKey, pubKey) {
  const rawKey = await crypto.subtle.exportKey("raw", aesKey);
  const wrapped = await crypto.subtle.encrypt({name: "RSA-OAEP"}, pubKey, rawKey);
  return bufToB64(wrapped);
}

async function unwrapKeyWithRsa(b64Wrapped, privKey) {
  const wrapped = b64ToBuf(b64Wrapped);
  const rawKey = await crypto.subtle.decrypt({name: "RSA-OAEP"}, privKey, wrapped);
  return crypto.subtle.importKey("raw", rawKey, "AES-GCM", true, ["encrypt", "decrypt"]);
}

/* --- ADMIN LOGIN LOGIC --- */
function openLogin() { document.getElementById('login-modal').classList.remove('hidden'); document.getElementById('admin-password').focus(); }
function closeLogin() { document.getElementById('login-modal').classList.add('hidden'); }

async function attemptAdminLogin() {
  const password = document.getElementById('admin-password').value;
  const btn = document.getElementById('unlock-btn');
  btn.innerText = "Verifying...";
  
  try {
    const salt = b64ToBuf(CONFIG.PRIVATE_KEY_SALT);
    const iv = b64ToBuf(CONFIG.PRIVATE_KEY_IV);
    const pwKeyMat = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
    const unwrapKey = await crypto.subtle.deriveKey(
      {name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256"},
      pwKeyMat, {name: "AES-GCM", length: 256}, false, ["decrypt"]
    );

    const encPriv = b64ToBuf(CONFIG.ENCRYPTED_PRIVATE_KEY);
    const privRaw = await crypto.subtle.decrypt({name: "AES-GCM", iv}, unwrapKey, encPriv);
    
    STATE.privateKey = await crypto.subtle.importKey(
      "pkcs8", privRaw, {name: "RSA-OAEP", hash: "SHA-256"}, false, ["decrypt"]
    );
    
    STATE.isAdmin = true;
    closeLogin();
    enableAdminUI();
    showToast("Admin Key Unlocked", "success");

  } catch(e) {
    console.error(e);
    showToast("Wrong Password", "error");
    document.getElementById('admin-password').value = "";
  } finally {
    btn.innerText = "Unlock Vault";
  }
}

function enableAdminUI() {
  document.getElementById('mode-badge').innerText = "Admin (Read/Write)";
  document.getElementById('mode-badge').className = "bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full";
  document.getElementById('lock-btn').classList.add('hidden');
  document.getElementById('delete-btn').classList.remove('hidden');
  document.getElementById('sidebar').classList.remove('hidden');
  refreshNotes();
}

/* --- APP LOGIC --- */
async function saveNote() {
  const title = document.getElementById('note-title').value.trim() || "Untitled";
  const body = document.getElementById('note-body').value;
  
  showToast("Encrypting...", "info");
  
  try {
    const sessionKey = await generateAesKey();
    const encBody = await aesEncrypt(JSON.stringify({text: body}), sessionKey);
    const pubKey = await importPublicKey(CONFIG.PUBLIC_KEY);
    const encSessionKey = await wrapKeyWithRsa(sessionKey, pubKey);

    const filesToUpload = [];
    for(const pf of STATE.pendingFiles) {
      const encF = await aesEncrypt(pf.raw, sessionKey);
      filesToUpload.push({ filename: pf.filename, data: encF.data, iv: encF.iv });
    }

    const packedData = JSON.stringify({
      body: encBody.data, 
      key: encSessionKey
    });

    const reqBody = {
      id: STATE.currentNote ? STATE.currentNote.id : null,
      title: title,
      salt: "N/A", 
      iv: encBody.iv, 
      data: btoa(packedData), 
      files: filesToUpload
    };

    const r = await fetch('/api/notes', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(reqBody)
    });

    if((await r.json()).ok) {
      showToast("Saved! (Guest cannot read)", "success");
      if(STATE.isAdmin) refreshNotes();
      else resetEditor();
    } else throw new Error("Server error");

  } catch(e) {
    console.error(e);
    showToast("Save Failed", "error");
  }
}

async function loadNote(id) {
  if(!STATE.isAdmin) return;
  document.getElementById('status-text').innerText = "Decrypting...";
  
  try {
    const r = await fetch(`/api/notes/${id}`);
    const note = await r.json();

    const packed = JSON.parse(atob(note.data));
    const sessionKey = await unwrapKeyWithRsa(packed.key, STATE.privateKey);
    const bodyStr = await aesDecrypt(packed.body, note.iv, sessionKey);
    const bodyObj = JSON.parse(bodyStr);

    STATE.currentNote = note;
    STATE.currentNote._sessionKey = sessionKey; 
    STATE.currentNote.files = note.files || [];
    STATE.pendingFiles = [];

    document.getElementById('note-title').value = note.title;
    document.getElementById('note-body').value = bodyObj.text || "";
    renderFiles();
    document.getElementById('status-text').innerText = "Decrypted";

  } catch(e) {
    console.error(e);
    showToast("Decryption Failed", "error");
  }
}

async function refreshNotes() {
  const r = await fetch('/api/notes');
  const d = await r.json();
  const el = document.getElementById('note-list');
  el.innerHTML = "";
  (d.notes||[]).forEach(n => {
    const div = document.createElement('div');
    div.className = "p-3 border-b border-gray-100 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700";
    div.innerHTML = `<div class="font-bold text-sm truncate dark:text-gray-200">${escapeHtml(n.title)}</div><div class="text-xs text-gray-400">${new Date(n.created_at).toLocaleDateString()}</div>`;
    div.onclick = () => loadNote(n.id);
    el.appendChild(div);
  });
}

function renderFiles() {
  const el = document.getElementById('file-list'); el.innerHTML = "";
  const chip = (n, s, pending, cb) => {
    const d = document.createElement('div');
    d.className = `flex items-center gap-2 px-3 py-1 text-xs rounded-full border ${pending?'bg-blue-50 text-blue-700':'bg-gray-100 dark:bg-gray-700 dark:text-gray-300'}`;
    d.innerHTML = `<i class="fa-solid fa-file"></i> <span class="truncate max-w-[120px]">${escapeHtml(n)}</span>`;
    if(cb) { const b = document.createElement('button'); b.innerHTML='<i class="fa-solid fa-download ml-1"></i>'; b.onclick=cb; d.appendChild(b); }
    el.appendChild(d);
  };
  (STATE.currentNote?.files||[]).forEach(f => chip(f.filename, f.size, false, () => downloadFile(f)));
  STATE.pendingFiles.forEach(f => chip(f.filename, f.raw.byteLength, true));
}

function handleFileSelect(inp) {
  Array.from(inp.files).forEach(async f => {
    const buf = await f.arrayBuffer();
    STATE.pendingFiles.push({filename:f.name, raw:buf});
    renderFiles();
  });
  inp.value="";
}

async function downloadFile(f) {
  try {
    const buf = await aesDecrypt(f.data, f.iv, STATE.currentNote._sessionKey, false);
    const url = URL.createObjectURL(new Blob([buf]));
    const a = document.createElement('a'); a.href=url; a.download=f.filename; a.click();
    URL.revokeObjectURL(url);
  } catch(e) { showToast("Download Failed", "error"); }
}

async function deleteNote() {
  if(!STATE.isAdmin || !STATE.currentNote) return;
  if(confirm("Delete note?")) {
    await fetch(`/api/notes/${STATE.currentNote.id}`, {method:'DELETE'});
    resetEditor(); refreshNotes();
  }
}

function resetEditor() {
  STATE.currentNote = null; STATE.pendingFiles = [];
  document.getElementById('note-title').value = "";
  document.getElementById('note-body').value = "";
  renderFiles();
}

function showToast(msg, type='info') {
  const d = document.createElement('div');
  d.className = `${type==='error'?'bg-red-600':'bg-gray-800'} text-white px-4 py-3 rounded shadow`;
  d.innerText = msg;
  document.getElementById('toast-container').appendChild(d);
  setTimeout(()=>d.remove(), 3000);
}

function toggleTheme() { document.body.classList.toggle('dark'); }
function escapeHtml(s) { return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):s; }
</script>
</body>
</html>


