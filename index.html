<!DOCTYPE html>
<html lang="en" class="h-full dark"> <!-- Added 'dark' class here for default dark mode -->
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>MyCloudText</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class', // Enables dark mode via the 'dark' class on HTML tag
  }
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
  
  /* Scrollbars */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; } /* Dark thumb by default */

  .loader { width: 18px; height: 18px; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  [x-cloak] { display: none !important; }

  /* Mobile Slide Animation */
  @media (max-width: 767px) {
    .view-panel { 
      position: absolute; inset: 0; 
      transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); 
      will-change: transform; 
      background: #030712; /* Dark background for sliding panels */
    }
    .view-hidden-right { transform: translateX(100%); }
    .view-active { transform: translateX(0); }
  }
</style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 h-full w-full overflow-hidden flex flex-col md:flex-row">

<script>
  const CONFIG = {
    PUBLIC_KEY: `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2nqjQh7Fx63wGaothYXH54+dM7fv/iZAMO5hbKvYGjAR37qraQjghW/qhXOrf/bPhh/ddIE14u8tUmqhE1hiODEU0+02LjRSW04BS56/WESSCqz5ueqk8DX4mGIKi3+w7q8WiR5u3MV/C+D7df79eevFN+rkXwMFhUTYfBokWqjd7Wn8S9s3TT6Ag6rW/7CWubRInwWgtMnS+cYklmAtKlWwj9CF/jFC39WyktrR8Ny6TXxL80eKAe7OYe8ZSd2kTWgqIrlWCBZ+ZSsfRNNvh3SneWTjN1/EYT0nqimweHi9tKhGhRheXm8MtCc/zpSayzRmky4ZdjsG9eT4GZS7fQIDAQAB
-----END PUBLIC KEY-----`,
    ENCRYPTED_PRIVATE_KEY: "sYuJ2UI7ybV/IadaoDR+aZvbSRLWyGcEjd16qZQaeVLmIR17LMrYb2ZAm2q9qEQK56NS6GRqp+ajdoBPHmQZLPZhvxO1NUtogIOin+PdBeyBR4TfWTKAFtKxdo3oEDzGipuxKB1HIL7Ig8h33KXmnw838sbaJqBe3nixvSffaD6wbSRS69mk4RHFFmNAzk2P7TZRq1+1NiRt1iYaB9Da/U1vVi8GookhDk+t45y2eRJBYcDtGdJXFs78U2xMczbOYzy7DYcS4JN3r8XnlHiWEvGxt8Pi1abb2F3dgsTomOIpUvOqvOsnIiFJYC/e8XckfL1VoTL8iqK6rUt+zIlLDilqsnIBhTr51uPNfZBJKZCqURWIu77iVbC8/Px/rytikpXh/KDaELEZVtBsCvndqEr9/msru4AfdYUNEJubWiYJSvuJ0Sef4fe/mcIOczcRU4JwwpUExIiiz3pSaAIvFO3QF13G9PqanK/PpGg9Bw5HHyssOJMbSwLaF4c6MNK0COpepQl1njyIyfH3yYqvam+luf7qFw5Nz9nHno6ryDNQI31trIlBs2Ih+NhP0NzkYZN98xRZuIKXntgyk0hBmXt3/3JOVl+09o8H/qa4ixDqwF5v86m+uCgsZLDeN/0c+PiQchTYl8Bkzt4v0Cshe4Z1IMWUZnWEWtO50edBK8bo2RadxQcvfrfSynjg3eOq/UiAK/W2raRiM5LQVHGNCGiwySCt3w3lNWYToZhGSy57WmfcNQtpdxjUMZf9TegafZJxqsaBcqXKlXyMToWWqsV90U5HnE1EJ3mkH70gAyLLk/QMTPaoYHUCRebI/R7PT9XDCetPRrEjCJ2+Jh4ZOj06KfxVCrARAJS45/Iuodo0gxtIQezJsVPLG4vtYiVeZNMLlvp14kjDAHZ9ACgStbLFZcaTImk1HlAzDsdBXnjgqYix/+kW5ajEV43gJqJA0YE6fX/s1GLOOkZyOF6nbLjbcJX+UJ4OAEzLszJF4bO5T31EyqO063raY3NHp8OHvBVeI7TD8UYUJeC6j/JXen/2wVpvmGmdcoIvnWmeyJnCNiHq3ac/a0pe9pP7ZMgCdEQ9FS/RZrubxHHAY6v/VW9wI4mI/N+lOeRkJ5sp4RmzO4ZoMp5IADlQ6gt7vy568XpZkAX4jbxClIgfrTWBSr4Tj9+nBVWagkjdf4ymyxjHtzKWoAfjk915hLUSZJ9rOpMYHVdn1PZovFlZZlb7z/p7fI/qHJc+9DE3JVVyuOMMQRFmH7nF/4ouukqsX2E+WVNtRpt0udQ+sbfr63QR+iospfxKRBoQPguRAFs3qe/ZE7UeoR/Hm4avT23RlAkRp/63jUyXtnr9y0+Edn05ydIh5arJI1MiDdh+CfdAv3qcsW2I3WDvvwLqrN3CzbmiXroNYDxkmE09R1sZgYTsvtuyGRpw09PDsMswPv/+7moXSE50zF1X+Xkopd5t0HezQo0JJx9215o08F/sqSGINZUTw9u5+adkVi10y0uOgT9sAGStAbb54P0+KlZZVvx03WxThUOA6k+fR+uveNDPBzv/WnCVryd3HamJ8apFMesc9Z2fDa8c2yWgQNbGl3M/HCmSG3X12nFIzcQTP4KsZz9JQ9sCtAkV4bj5I50niNTR/A==",
    PRIVATE_KEY_SALT: "0lsVUhXMCplY/6RSOqdX7w==",
    PRIVATE_KEY_IV: "GhU37eqb7/9qD2xk"
  };
</script>

<!-- TOASTS -->
<div id="toast-container" class="fixed top-14 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-max max-w-[90vw] pointer-events-none"></div>

<!-- ADMIN MODAL -->
<div id="login-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end md:items-center justify-center hidden opacity-0 transition-opacity duration-300">
  <div class="bg-gray-900 w-full md:max-w-sm p-6 rounded-t-2xl md:rounded-2xl shadow-2xl border border-gray-800 transform transition-transform duration-300 translate-y-full md:translate-y-0">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold flex items-center gap-2 text-white"><i class="fa-solid fa-user-shield text-blue-500"></i> Admin Login</h2>
      <button onclick="closeLogin()" class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="space-y-4">
      <input type="password" id="admin-password" placeholder="Master Password" 
        class="w-full px-4 py-3 bg-gray-950 border border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-lg text-white placeholder-gray-600"
        onkeyup="if(event.key==='Enter') attemptAdminLogin()">
      <button onclick="attemptAdminLogin()" id="unlock-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 flex justify-center gap-2">Unlock</button>
    </div>
  </div>
</div>

<!-- == LAYOUT == -->

<!-- SIDEBAR / LIST -->
<aside id="view-list" class="view-panel view-active md:relative md:w-80 md:flex md:flex-col md:border-r border-gray-800 bg-gray-950 z-10">
  <header class="h-16 flex items-center justify-between px-5 border-b border-gray-800 shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/20"><i class="fa-solid fa-cloud"></i></div>
      <div class="flex flex-col">
        <h1 class="font-bold text-base leading-none text-white">MyCloudText</h1>
        <span id="mode-badge" class="text-[10px] font-bold text-gray-500 uppercase tracking-wider mt-0.5">Guest Mode</span>
      </div>
    </div>
    <button onclick="openLogin()" id="lock-btn" class="w-9 h-9 rounded-full hover:bg-gray-900 flex items-center justify-center text-gray-400 transition-colors" title="Admin Login"><i class="fa-solid fa-lock"></i></button>
  </header>

  <div class="hidden md:block px-4 py-4">
    <button onclick="createNewNote()" class="w-full bg-gray-900 hover:bg-gray-800 text-blue-400 font-semibold py-2.5 rounded-lg flex items-center justify-center gap-2 transition-colors border border-gray-800">
      <i class="fa-solid fa-plus"></i> New Secure Note
    </button>
  </div>

  <div id="note-list" class="flex-1 overflow-y-auto p-2 pb-24 md:pb-2">
    <div class="flex flex-col items-center justify-center h-64 text-center px-6">
      <i class="fa-solid fa-file-shield text-4xl text-gray-800 mb-4"></i>
      <p class="text-sm text-gray-600">Secure Storage Active.<br>Login to view notes.</p>
    </div>
  </div>

  <button onclick="createNewNote()" class="md:hidden absolute bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl shadow-blue-600/40 flex items-center justify-center text-2xl active:scale-90 transition-transform z-30"><i class="fa-solid fa-pen"></i></button>
</aside>

<!-- EDITOR -->
<main id="view-editor" class="view-panel view-hidden-right md:transform-none md:static md:flex-1 bg-gray-900 z-20 flex flex-col h-full w-full">
  <div class="h-16 px-4 flex items-center justify-between border-b border-gray-800 bg-gray-950 shrink-0">
    <div class="flex items-center gap-3">
      <button onclick="goBack()" class="md:hidden w-10 h-10 -ml-2 rounded-full hover:bg-gray-800 flex items-center justify-center text-gray-400"><i class="fa-solid fa-arrow-left"></i></button>
      <span id="status-text" class="text-xs font-bold text-gray-500 uppercase tracking-wider">New Note</span>
    </div>
    <div class="flex items-center gap-2">
      <input type="file" id="file-input" multiple class="hidden" onchange="handleFileSelect(this)">
      <button onclick="document.getElementById('file-input').click()" class="w-10 h-10 rounded-full hover:bg-gray-800 text-gray-500 relative transition-colors"><i class="fa-solid fa-paperclip"></i><span id="file-badge" class="hidden absolute top-2.5 right-2.5 w-2 h-2 bg-blue-500 rounded-full"></span></button>
      <button onclick="saveNote()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-5 py-2 rounded-lg shadow-lg shadow-blue-500/20 active:scale-95 transition-all text-sm">Save</button>
      <button id="delete-btn" onclick="deleteNote()" class="hidden w-10 h-10 rounded-full text-red-500 hover:bg-red-900/20 flex items-center justify-center transition-colors"><i class="fa-regular fa-trash-can"></i></button>
    </div>
  </div>

  <div class="flex-1 overflow-y-auto">
    <div class="max-w-4xl mx-auto p-6 md:p-10 pb-32 min-h-full flex flex-col">
      <input id="note-title" type="text" placeholder="Note Title" class="bg-transparent text-3xl md:text-4xl font-bold text-gray-100 placeholder-gray-700 border-none focus:ring-0 p-0 mb-6 w-full outline-none">
      <textarea id="note-body" placeholder="Start typing securely..." class="flex-1 bg-transparent resize-none text-lg md:text-xl leading-relaxed text-gray-300 border-none focus:ring-0 p-0 w-full outline-none placeholder-gray-700"></textarea>
      <div id="file-list" class="flex flex-wrap gap-3 mt-8 pt-6 border-t border-gray-800 empty:hidden"></div>
    </div>
  </div>
</main>

<script>
/* --- LOGIC --- */
const isMobile = () => window.innerWidth < 768;
function goBack() {
  if (!isMobile()) return;
  document.getElementById('view-editor').classList.add('view-hidden-right');
  document.getElementById('view-editor').classList.remove('view-active');
  if(!STATE.isAdmin) setTimeout(resetEditor, 300);
}
function createNewNote() {
  resetEditor();
  document.getElementById('view-editor').classList.remove('view-hidden-right');
  document.getElementById('view-editor').classList.add('view-active');
  setTimeout(() => document.getElementById('note-title').focus(), 100);
}

const STATE = { isAdmin: false, privateKey: null, notes: [], currentNote: null, pendingFiles: [] };
const enc = new TextEncoder(), dec = new TextDecoder();
const bufToB64 = b => btoa(String.fromCharCode(...new Uint8Array(b)));
const b64ToBuf = b => Uint8Array.from(atob(b), c => c.charCodeAt(0));

async function aesEncrypt(data, key) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const buf = typeof data === 'string' ? enc.encode(data) : data;
  const ct = await crypto.subtle.encrypt({name: "AES-GCM", iv}, key, buf);
  return { iv: bufToB64(iv), data: bufToB64(ct) };
}
async function aesDecrypt(b64Data, b64Iv, key, isText=true) {
  const pt = await crypto.subtle.decrypt({name: "AES-GCM", iv: b64ToBuf(b64Iv)}, key, b64ToBuf(b64Data));
  return isText ? dec.decode(pt) : pt;
}
async function importPublicKey(pem) {
  const b64 = pem.replace(/-----(BEGIN|END) PUBLIC KEY-----|\n/g, "");
  return crypto.subtle.importKey("spki", b64ToBuf(b64), {name: "RSA-OAEP", hash: "SHA-256"}, false, ["encrypt"]);
}
async function wrapKey(aesKey, pubKey) {
  const raw = await crypto.subtle.exportKey("raw", aesKey);
  return bufToB64(await crypto.subtle.encrypt({name: "RSA-OAEP"}, pubKey, raw));
}
async function unwrapKey(b64Wrapped, privKey) {
  const raw = await crypto.subtle.decrypt({name: "RSA-OAEP"}, privKey, b64ToBuf(b64Wrapped));
  return crypto.subtle.importKey("raw", raw, "AES-GCM", true, ["encrypt", "decrypt"]);
}

function openLogin() { const el=document.getElementById('login-modal'); el.classList.remove('hidden'); setTimeout(()=>el.classList.remove('opacity-0'),10); }
function closeLogin() { const el=document.getElementById('login-modal'); el.classList.add('opacity-0'); setTimeout(()=>el.classList.add('hidden'),300); }

async function attemptAdminLogin() {
  const pw = document.getElementById('admin-password').value;
  const btn = document.getElementById('unlock-btn');
  const orgHtml = btn.innerHTML; btn.innerHTML = `<div class="loader text-white"></div>`;
  try {
    const salt = b64ToBuf(CONFIG.PRIVATE_KEY_SALT), iv = b64ToBuf(CONFIG.PRIVATE_KEY_IV);
    const keyMat = await crypto.subtle.importKey("raw", enc.encode(pw), "PBKDF2", false, ["deriveKey"]);
    const unwrap = await crypto.subtle.deriveKey({name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256"}, keyMat, {name: "AES-GCM", length: 256}, false, ["decrypt"]);
    const privRaw = await crypto.subtle.decrypt({name: "AES-GCM", iv}, unwrap, b64ToBuf(CONFIG.ENCRYPTED_PRIVATE_KEY));
    STATE.privateKey = await crypto.subtle.importKey("pkcs8", privRaw, {name: "RSA-OAEP", hash: "SHA-256"}, false, ["decrypt"]);
    STATE.isAdmin = true; closeLogin(); enableAdminUI(); showToast("Vault Unlocked", "success");
  } catch(e) { showToast("Incorrect Password", "error"); btn.innerHTML = orgHtml; }
}

function enableAdminUI() {
  document.getElementById('mode-badge').innerText = "ADMIN ACCESS";
  document.getElementById('mode-badge').className = "text-[10px] font-bold text-blue-500 uppercase tracking-wider mt-0.5";
  document.getElementById('lock-btn').classList.add('hidden');
  document.getElementById('delete-btn').classList.remove('hidden');
  refreshNotes();
}

async function saveNote() {
  const title = document.getElementById('note-title').value.trim() || "Untitled";
  const body = document.getElementById('note-body').value;
  if(!body && STATE.pendingFiles.length===0) return showToast("Cannot save empty note", "error");
  showToast("Encrypting...", "info");
  try {
    const sessionKey = await crypto.subtle.generateKey({name: "AES-GCM", length: 256}, true, ["encrypt", "decrypt"]);
    const encBody = await aesEncrypt(JSON.stringify({text: body}), sessionKey);
    const pubKey = await importPublicKey(CONFIG.PUBLIC_KEY);
    const encKey = await wrapKey(sessionKey, pubKey);
    
    const filesToUpload = [];
    for(const pf of STATE.pendingFiles) {
      const encF = await aesEncrypt(pf.raw, sessionKey);
      filesToUpload.push({ filename: pf.filename, data: encF.data, iv: encF.iv });
    }
    
    const reqBody = {
      id: STATE.currentNote?.id, title, salt: "N/A", iv: encBody.iv, 
      data: btoa(JSON.stringify({ body: encBody.data, key: encKey })), 
      files: filesToUpload
    };

    const r = await fetch('/api/notes', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(reqBody) });
    if((await r.json()).ok) {
      showToast("Saved Securely", "success");
      if(STATE.isAdmin) refreshNotes(); else { resetEditor(); goBack(); }
    } else throw new Error();
  } catch(e) { showToast("Save Failed", "error"); }
}

async function loadNote(id) {
  if(!STATE.isAdmin) return;
  document.getElementById('status-text').innerText = "Decrypting...";
  createNewNote(); // Open view
  
  // Highlight in list (Desktop)
  document.querySelectorAll('.note-item').forEach(el => el.classList.remove('bg-gray-800', 'border-l-4', 'border-blue-500'));
  const activeEl = document.getElementById(`note-${id}`);
  if(activeEl) activeEl.classList.add('bg-gray-800', 'border-l-4', 'border-blue-500');

  try {
    const r = await fetch(`/api/notes/${id}`);
    const note = await r.json();
    const packed = JSON.parse(atob(note.data));
    const sessionKey = await unwrapKey(packed.key, STATE.privateKey);
    const bodyStr = await aesDecrypt(packed.body, note.iv, sessionKey);
    
    STATE.currentNote = note; STATE.currentNote._sessionKey = sessionKey; 
    STATE.currentNote.files = note.files || []; STATE.pendingFiles = [];
    
    document.getElementById('note-title').value = note.title;
    document.getElementById('note-body').value = JSON.parse(bodyStr).text || "";
    renderFiles();
    document.getElementById('status-text').innerText = "Last Saved: " + new Date(note.created_at).toLocaleTimeString();
  } catch(e) { showToast("Decryption Failed", "error"); if(isMobile()) goBack(); }
}

async function refreshNotes() {
  const r = await fetch('/api/notes'); const d = await r.json();
  const el = document.getElementById('note-list'); el.innerHTML = "";
  if(!d.notes?.length) { el.innerHTML = `<div class="flex flex-col items-center justify-center h-40 text-gray-500 text-sm"><p>No notes found.</p></div>`; return; }
  d.notes.forEach(n => {
    const div = document.createElement('div');
    div.id = `note-${n.id}`;
    div.className = "note-item w-full text-left p-4 border-b border-gray-800 hover:bg-gray-900 transition-all cursor-pointer";
    div.innerHTML = `<div class="font-bold text-gray-100 truncate text-sm mb-1 hover:text-blue-400 transition-colors">${escapeHtml(n.title||"Untitled")}</div><div class="flex justify-between text-xs text-gray-500"><span>${new Date(n.created_at).toLocaleDateString()}</span>${n.files?.length?'<i class="fa-solid fa-paperclip text-blue-500"></i>':''}</div>`;
    div.onclick = () => loadNote(n.id);
    el.appendChild(div);
  });
}

function handleFileSelect(inp) {
  if(!inp.files.length) return;
  Array.from(inp.files).forEach(async f => {
    if(f.size > 10*1024*1024) return showToast(`âŒ ${f.name} > 10MB`, "error");
    try {
      const buf = await f.arrayBuffer();
      STATE.pendingFiles.push({filename:f.name, raw:buf});
      renderFiles();
    } catch(e) { showToast(`Error reading ${f.name}`, "error"); }
  });
  inp.value="";
}

function renderFiles() {
  const el = document.getElementById('file-list'); el.innerHTML = "";
  const all = [...(STATE.currentNote?.files||[]).map(f=>({...f,rem:true})), ...STATE.pendingFiles.map(f=>({...f,rem:false}))];
  document.getElementById('file-badge').classList.toggle('hidden', !all.length);
  all.forEach(f => {
    const d = document.createElement('div');
    d.className = `inline-flex items-center gap-2 px-3 py-2 text-sm rounded-lg border ${f.rem?'bg-gray-800 border-gray-700 text-gray-300':'bg-blue-900/30 border-blue-800 text-blue-300'}`;
    d.innerHTML = `<i class="fa-solid ${f.rem?'fa-file text-gray-500':'fa-upload'}"></i> <span class="max-w-[120px] truncate font-medium">${escapeHtml(f.filename)}</span>`;
    if(f.rem && STATE.isAdmin) { d.onclick = async () => {
      showToast("Decrypting...", "info");
      const buf = await aesDecrypt(f.data, f.iv, STATE.currentNote._sessionKey, false);
      const url = URL.createObjectURL(new Blob([buf]));
      const a = document.createElement('a'); a.href=url; a.download=f.filename; a.click();
    }; d.classList.add('cursor-pointer','hover:bg-gray-700'); }
    el.appendChild(d);
  });
}

async function deleteNote() {
  if(STATE.isAdmin && STATE.currentNote && confirm("Permanently delete this note?")) {
    await fetch(`/api/notes/${STATE.currentNote.id}`, {method:'DELETE'});
    resetEditor(); refreshNotes(); if(isMobile()) goBack(); showToast("Deleted", "info");
  }
}

function resetEditor() {
  STATE.currentNote = null; STATE.pendingFiles = [];
  document.getElementById('note-title').value = ""; document.getElementById('note-body').value = "";
  document.getElementById('status-text').innerText = "New Note";
  document.querySelectorAll('.note-item').forEach(el => el.classList.remove('bg-gray-800', 'border-l-4', 'border-blue-500'));
  renderFiles();
}
function showToast(msg, type='info') {
  const d = document.createElement('div');
  d.className = `${type==='error'?'bg-red-600':type==='success'?'bg-green-600':'bg-gray-800'} text-white px-4 py-2.5 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 animate-bounce-in border border-gray-700`;
  d.innerHTML = `<span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(d); setTimeout(()=>d.remove(),2500);
}
function escapeHtml(s) { return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):s; }
document.addEventListener('keydown', e => { if((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveNote(); } if(e.key === 'Escape') closeLogin(); });
</script>
</body>
</html>


