<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<!-- Prevent zooming on inputs and handle safe areas for iPhone Notch -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>MyCloudText â€” Secure</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  /* Native App Feel */
  body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
  
  /* Smooth Slide Transitions for Mobile */
  .view-container { transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
  .view-active { transform: translateX(0); }
  .view-hidden-right { transform: translateX(100%); }
  .view-hidden-left { transform: translateX(-30%); } /* Parallax effect */

  /* Custom Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  .dark ::-webkit-scrollbar-thumb { background: #475569; }

  /* Utility */
  .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
  .loader { width: 18px; height: 18px; border: 2px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  [x-cloak] { display: none !important; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 h-[100dvh] w-screen overflow-hidden flex flex-col transition-colors duration-200">

<!-- ================================================================= -->
<!-- CONFIGURATION (Pre-filled with your keys)                         -->
<!-- ================================================================= -->
<script>
  const CONFIG = {
    PUBLIC_KEY: `-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2nqjQh7Fx63wGaothYXH54+dM7fv/iZAMO5hbKvYGjAR37qraQjghW/qhXOrf/bPhh/ddIE14u8tUmqhE1hiODEU0+02LjRSW04BS56/WESSCqz5ueqk8DX4mGIKi3+w7q8WiR5u3MV/C+D7df79eevFN+rkXwMFhUTYfBokWqjd7Wn8S9s3TT6Ag6rW/7CWubRInwWgtMnS+cYklmAtKlWwj9CF/jFC39WyktrR8Ny6TXxL80eKAe7OYe8ZSd2kTWgqIrlWCBZ+ZSsfRNNvh3SneWTjN1/EYT0nqimweHi9tKhGhRheXm8MtCc/zpSayzRmky4ZdjsG9eT4GZS7fQIDAQAB
-----END PUBLIC KEY-----`,
    ENCRYPTED_PRIVATE_KEY: "sYuJ2UI7ybV/IadaoDR+aZvbSRLWyGcEjd16qZQaeVLmIR17LMrYb2ZAm2q9qEQK56NS6GRqp+ajdoBPHmQZLPZhvxO1NUtogIOin+PdBeyBR4TfWTKAFtKxdo3oEDzGipuxKB1HIL7Ig8h33KXmnw838sbaJqBe3nixvSffaD6wbSRS69mk4RHFFmNAzk2P7TZRq1+1NiRt1iYaB9Da/U1vVi8GookhDk+t45y2eRJBYcDtGdJXFs78U2xMczbOYzy7DYcS4JN3r8XnlHiWEvGxt8Pi1abb2F3dgsTomOIpUvOqvOsnIiFJYC/e8XckfL1VoTL8iqK6rUt+zIlLDilqsnIBhTr51uPNfZBJKZCqURWIu77iVbC8/Px/rytikpXh/KDaELEZVtBsCvndqEr9/msru4AfdYUNEJubWiYJSvuJ0Sef4fe/mcIOczcRU4JwwpUExIiiz3pSaAIvFO3QF13G9PqanK/PpGg9Bw5HHyssOJMbSwLaF4c6MNK0COpepQl1njyIyfH3yYqvam+luf7qFw5Nz9nHno6ryDNQI31trIlBs2Ih+NhP0NzkYZN98xRZuIKXntgyk0hBmXt3/3JOVl+09o8H/qa4ixDqwF5v86m+uCgsZLDeN/0c+PiQchTYl8Bkzt4v0Cshe4Z1IMWUZnWEWtO50edBK8bo2RadxQcvfrfSynjg3eOq/UiAK/W2raRiM5LQVHGNCGiwySCt3w3lNWYToZhGSy57WmfcNQtpdxjUMZf9TegafZJxqsaBcqXKlXyMToWWqsV90U5HnE1EJ3mkH70gAyLLk/QMTPaoYHUCRebI/R7PT9XDCetPRrEjCJ2+Jh4ZOj06KfxVCrARAJS45/Iuodo0gxtIQezJsVPLG4vtYiVeZNMLlvp14kjDAHZ9ACgStbLFZcaTImk1HlAzDsdBXnjgqYix/+kW5ajEV43gJqJA0YE6fX/s1GLOOkZyOF6nbLjbcJX+UJ4OAEzLszJF4bO5T31EyqO063raY3NHp8OHvBVeI7TD8UYUJeC6j/JXen/2wVpvmGmdcoIvnWmeyJnCNiHq3ac/a0pe9pP7ZMgCdEQ9FS/RZrubxHHAY6v/VW9wI4mI/N+lOeRkJ5sp4RmzO4ZoMp5IADlQ6gt7vy568XpZkAX4jbxClIgfrTWBSr4Tj9+nBVWagkjdf4ymyxjHtzKWoAfjk915hLUSZJ9rOpMYHVdn1PZovFlZZlb7z/p7fI/qHJc+9DE3JVVyuOMMQRFmH7nF/4ouukqsX2E+WVNtRpt0udQ+sbfr63QR+iospfxKRBoQPguRAFs3qe/ZE7UeoR/Hm4avT23RlAkRp/63jUyXtnr9y0+Edn05ydIh5arJI1MiDdh+CfdAv3qcsW2I3WDvvwLqrN3CzbmiXroNYDxkmE09R1sZgYTsvtuyGRpw09PDsMswPv/+7moXSE50zF1X+Xkopd5t0HezQo0JJx9215o08F/sqSGINZUTw9u5+adkVi10y0uOgT9sAGStAbb54P0+KlZZVvx03WxThUOA6k+fR+uveNDPBzv/WnCVryd3HamJ8apFMesc9Z2fDa8c2yWgQNbGl3M/HCmSG3X12nFIzcQTP4KsZz9JQ9sCtAkV4bj5I50niNTR/A==",
    PRIVATE_KEY_SALT: "0lsVUhXMCplY/6RSOqdX7w==",
    PRIVATE_KEY_IV: "GhU37eqb7/9qD2xk"
  };
</script>

<!-- TOAST CONTAINER -->
<div id="toast-container" class="fixed top-14 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-max max-w-[90vw] pointer-events-none"></div>

<!-- ADMIN LOGIN MODAL -->
<div id="login-modal" class="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center hidden opacity-0 transition-opacity duration-300">
  <div class="bg-white dark:bg-gray-900 w-full sm:max-w-sm p-6 rounded-t-2xl sm:rounded-2xl shadow-2xl transform transition-transform duration-300 translate-y-full sm:translate-y-0">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-user-shield text-blue-500"></i> Admin Access</h2>
      <button onclick="closeLogin()" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="space-y-4">
      <input type="password" id="admin-password" placeholder="Master Password" 
        class="w-full px-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-lg"
        onkeyup="if(event.key==='Enter') attemptAdminLogin()">
      <button onclick="attemptAdminLogin()" id="unlock-btn" class="w-full bg-blue-600 active:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/30 transition-all flex justify-center items-center gap-2">
        Unlock Vault
      </button>
    </div>
    <div class="mt-6 text-center text-xs text-gray-400">
      Guests can write. Only you can read.
    </div>
  </div>
</div>

<!-- ======================= APP LAYOUT ======================= -->
<div class="relative w-full h-full overflow-hidden bg-white dark:bg-gray-950">
  
  <!-- VIEW 1: LIST / HOME (Sidebar on Desktop, Main View on Mobile) -->
  <aside id="view-list" class="absolute inset-0 md:w-80 md:border-r border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-950 z-10 flex flex-col view-container view-active">
    
    <!-- Header -->
    <header class="h-16 flex items-center justify-between px-5 border-b border-gray-100 dark:border-gray-800 shrink-0">
      <div class="flex items-center gap-2.5">
        <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/20">
          <i class="fa-solid fa-cloud"></i>
        </div>
        <div>
          <h1 class="font-bold text-lg leading-tight tracking-tight">MyCloudText</h1>
          <div id="mode-badge" class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Guest Mode</div>
        </div>
      </div>
      <div class="flex gap-1">
        <button onclick="openLogin()" id="lock-btn" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-900 flex items-center justify-center text-gray-400 transition-colors">
          <i class="fa-solid fa-lock"></i>
        </button>
        <button onclick="toggleTheme()" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-900 flex items-center justify-center text-gray-400 transition-colors">
          <i class="fa-solid fa-moon"></i>
        </button>
      </div>
    </header>

    <!-- Scrollable List -->
    <div id="note-list" class="flex-1 overflow-y-auto overflow-x-hidden pb-20">
      <!-- Empty State -->
      <div class="flex flex-col items-center justify-center h-64 text-center px-6">
        <div class="w-16 h-16 bg-gray-100 dark:bg-gray-900 rounded-full flex items-center justify-center text-gray-300 mb-4 text-2xl">
          <i class="fa-solid fa-eye-slash"></i>
        </div>
        <h3 class="font-medium text-gray-900 dark:text-gray-100">Encrypted Storage</h3>
        <p class="text-sm text-gray-400 mt-1 max-w-[200px]">Notes you write are encrypted. Log in to decrypt and read them.</p>
      </div>
    </div>

    <!-- Mobile FAB (Floating Action Button) -->
    <button onclick="createNewNote()" class="md:hidden absolute bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-xl shadow-blue-600/30 flex items-center justify-center text-2xl active:scale-95 transition-transform z-20">
      <i class="fa-solid fa-plus"></i>
    </button>
  </aside>

  <!-- VIEW 2: EDITOR (Main Content) -->
  <main id="view-editor" class="absolute inset-0 md:static md:flex-1 md:translate-x-0 bg-gray-50 dark:bg-gray-900 z-20 flex flex-col view-container view-hidden-right">
    
    <!-- Editor Header -->
    <div class="h-16 px-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shrink-0">
      <div class="flex items-center gap-2">
        <button onclick="goBack()" class="md:hidden -ml-2 w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 flex items-center justify-center text-gray-500">
          <i class="fa-solid fa-chevron-left"></i>
        </button>
        <span id="status-text" class="text-xs font-bold text-gray-400 uppercase tracking-wider">New Note</span>
      </div>
      
      <div class="flex items-center gap-2">
        <input type="file" id="file-input" multiple class="hidden" onchange="handleFileSelect(this)">
        <button onclick="document.getElementById('file-input').click()" class="w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 relative">
          <i class="fa-solid fa-paperclip"></i>
          <span id="file-badge" class="hidden absolute top-2 right-2 w-2.5 h-2.5 bg-blue-500 rounded-full border-2 border-white dark:border-gray-900"></span>
        </button>
        
        <button onclick="saveNote()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-5 py-2 rounded-full shadow-lg shadow-blue-500/20 active:scale-95 transition-all flex items-center gap-2 text-sm">
          <span>Save</span>
          <i class="fa-solid fa-check"></i>
        </button>
        
        <button id="delete-btn" onclick="deleteNote()" class="hidden w-10 h-10 rounded-full text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center justify-center transition-colors">
          <i class="fa-regular fa-trash-can"></i>
        </button>
      </div>
    </div>

    <!-- Scrollable Editor Area -->
    <div class="flex-1 overflow-y-auto">
      <div class="max-w-3xl mx-auto p-5 pb-32 min-h-full flex flex-col">
        <input id="note-title" type="text" placeholder="Title" 
          class="bg-transparent text-3xl font-bold text-gray-900 dark:text-gray-100 placeholder-gray-300 dark:placeholder-gray-700 border-none focus:ring-0 p-0 mb-6 w-full outline-none">
        
        <textarea id="note-body" placeholder="Start typing securely..." 
          class="flex-1 bg-transparent resize-none text-lg leading-relaxed text-gray-700 dark:text-gray-300 border-none focus:ring-0 p-0 w-full outline-none placeholder-gray-300 dark:placeholder-gray-700"></textarea>
        
        <!-- Attachments Preview -->
        <div id="file-list" class="flex flex-wrap gap-2 mt-8 empty:hidden"></div>
      </div>
    </div>
  </main>

</div>

<!-- ======================= LOGIC ======================= -->
<script>
/* --- MOBILE NAVIGATION --- */
function isMobile() { return window.innerWidth < 768; }

function goBack() {
  if (!isMobile()) return;
  document.getElementById('view-editor').classList.add('view-hidden-right');
  document.getElementById('view-editor').classList.remove('view-active');
  document.getElementById('view-list').classList.remove('view-hidden-left');
  
  // Clear selection if we are just a guest going back
  if (!STATE.isAdmin) setTimeout(() => resetEditor(), 300);
}

function openEditor() {
  document.getElementById('view-editor').classList.remove('view-hidden-right');
  document.getElementById('view-editor').classList.add('view-active');
  if (isMobile()) document.getElementById('view-list').classList.add('view-hidden-left');
}

function createNewNote() {
  resetEditor();
  openEditor();
  setTimeout(() => document.getElementById('note-title').focus(), 100);
}

/* --- STATE --- */
const STATE = {
  isAdmin: false,
  privateKey: null, 
  notes: [],
  currentNote: null,
  pendingFiles: []
};

/* --- CRYPTO ENGINE --- */
const enc = new TextEncoder();
const dec = new TextDecoder();
const bufToB64 = b => btoa(String.fromCharCode(...new Uint8Array(b)));
const b64ToBuf = b => Uint8Array.from(atob(b), c => c.charCodeAt(0));

async function generateAesKey() { return crypto.subtle.generateKey({name: "AES-GCM", length: 256}, true, ["encrypt", "decrypt"]); }
async function aesEncrypt(data, key) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const buf = typeof data === 'string' ? enc.encode(data) : data;
  const ct = await crypto.subtle.encrypt({name: "AES-GCM", iv}, key, buf);
  return { iv: bufToB64(iv), data: bufToB64(ct) };
}
async function aesDecrypt(b64Data, b64Iv, key, isText=true) {
  const iv = b64ToBuf(b64Iv); const ct = b64ToBuf(b64Data);
  const pt = await crypto.subtle.decrypt({name: "AES-GCM", iv}, key, ct);
  return isText ? dec.decode(pt) : pt;
}
async function importPublicKey(pem) {
  const b64 = pem.replace(/-----(BEGIN|END) PUBLIC KEY-----|\n/g, "");
  return crypto.subtle.importKey("spki", b64ToBuf(b64), {name: "RSA-OAEP", hash: "SHA-256"}, false, ["encrypt"]);
}
async function wrapKeyWithRsa(aesKey, pubKey) {
  const rawKey = await crypto.subtle.exportKey("raw", aesKey);
  const wrapped = await crypto.subtle.encrypt({name: "RSA-OAEP"}, pubKey, rawKey);
  return bufToB64(wrapped);
}
async function unwrapKeyWithRsa(b64Wrapped, privKey) {
  const wrapped = b64ToBuf(b64Wrapped);
  const rawKey = await crypto.subtle.decrypt({name: "RSA-OAEP"}, privKey, wrapped);
  return crypto.subtle.importKey("raw", rawKey, "AES-GCM", true, ["encrypt", "decrypt"]);
}

/* --- AUTH --- */
function openLogin() { 
  const el = document.getElementById('login-modal');
  el.classList.remove('hidden');
  setTimeout(() => { el.classList.remove('opacity-0'); el.firstElementChild.classList.remove('translate-y-full'); }, 10);
  document.getElementById('admin-password').focus();
}
function closeLogin() {
  const el = document.getElementById('login-modal');
  el.classList.add('opacity-0'); el.firstElementChild.classList.add('translate-y-full');
  setTimeout(() => el.classList.add('hidden'), 300);
}

async function attemptAdminLogin() {
  const password = document.getElementById('admin-password').value;
  const btn = document.getElementById('unlock-btn');
  const originalText = btn.innerHTML;
  btn.innerHTML = `<div class="loader"></div>`;
  
  try {
    const salt = b64ToBuf(CONFIG.PRIVATE_KEY_SALT);
    const iv = b64ToBuf(CONFIG.PRIVATE_KEY_IV);
    const pwKeyMat = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
    const unwrapKey = await crypto.subtle.deriveKey({name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256"}, pwKeyMat, {name: "AES-GCM", length: 256}, false, ["decrypt"]);
    const encPriv = b64ToBuf(CONFIG.ENCRYPTED_PRIVATE_KEY);
    const privRaw = await crypto.subtle.decrypt({name: "AES-GCM", iv}, unwrapKey, encPriv);
    STATE.privateKey = await crypto.subtle.importKey("pkcs8", privRaw, {name: "RSA-OAEP", hash: "SHA-256"}, false, ["decrypt"]);
    
    STATE.isAdmin = true;
    closeLogin();
    enableAdminUI();
    showToast("ðŸ”“ Vault Unlocked", "success");
  } catch(e) {
    showToast("Incorrect Password", "error");
    document.getElementById('admin-password').value = "";
    btn.innerHTML = originalText;
  }
}

function enableAdminUI() {
  document.getElementById('mode-badge').innerText = "ADMIN ACCESS";
  document.getElementById('mode-badge').className = "text-[10px] font-bold text-blue-500 tracking-wider";
  document.getElementById('lock-btn').classList.add('hidden');
  document.getElementById('delete-btn').classList.remove('hidden');
  
  // Add "New" button to sidebar top for Desktop convenience
  if(!isMobile()){
     // Logic handled by FAB or header
  }
  refreshNotes();
}

/* --- NOTES --- */
async function saveNote() {
  const title = document.getElementById('note-title').value.trim() || "Untitled";
  const body = document.getElementById('note-body').value;
  
  if(!body && STATE.pendingFiles.length === 0) return showToast("Note is empty", "error");
  showToast("Encrypting...", "info");
  
  try {
    const sessionKey = await generateAesKey();
    const encBody = await aesEncrypt(JSON.stringify({text: body}), sessionKey);
    const pubKey = await importPublicKey(CONFIG.PUBLIC_KEY);
    const encSessionKey = await wrapKeyWithRsa(sessionKey, pubKey);

    const filesToUpload = [];
    for(const pf of STATE.pendingFiles) {
      const encF = await aesEncrypt(pf.raw, sessionKey);
      filesToUpload.push({ filename: pf.filename, data: encF.data, iv: encF.iv });
    }

    const packedData = JSON.stringify({ body: encBody.data, key: encSessionKey });
    const reqBody = {
      id: STATE.currentNote ? STATE.currentNote.id : null,
      title: title, salt: "N/A", iv: encBody.iv, data: btoa(packedData), files: filesToUpload
    };

    const r = await fetch('/api/notes', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(reqBody) });
    if((await r.json()).ok) {
      showToast("âœ… Saved Securely", "success");
      if(STATE.isAdmin) refreshNotes();
      else { resetEditor(); goBack(); }
    } else throw new Error("Server error");
  } catch(e) { showToast("Save Failed", "error"); }
}

async function loadNote(id) {
  if(!STATE.isAdmin) return;
  document.getElementById('status-text').innerText = "Decrypting...";
  openEditor(); // Slide in view
  
  try {
    const r = await fetch(`/api/notes/${id}`);
    const note = await r.json();
    const packed = JSON.parse(atob(note.data));
    const sessionKey = await unwrapKeyWithRsa(packed.key, STATE.privateKey);
    const bodyStr = await aesDecrypt(packed.body, note.iv, sessionKey);
    const bodyObj = JSON.parse(bodyStr);

    STATE.currentNote = note;
    STATE.currentNote._sessionKey = sessionKey; 
    STATE.currentNote.files = note.files || [];
    STATE.pendingFiles = [];

    document.getElementById('note-title').value = note.title;
    document.getElementById('note-body').value = bodyObj.text || "";
    renderFiles();
    document.getElementById('status-text').innerText = "Last Saved: " + new Date(note.created_at).toLocaleTimeString();
  } catch(e) {
    showToast("Decryption Failed", "error");
    goBack();
  }
}

async function refreshNotes() {
  const r = await fetch('/api/notes');
  const d = await r.json();
  const el = document.getElementById('note-list');
  el.innerHTML = ""; // Clear
  
  if(!d.notes || d.notes.length === 0) {
    el.innerHTML = `<div class="text-center mt-20 text-gray-400 text-sm">No notes found.</div>`;
    return;
  }

  d.notes.forEach(n => {
    const div = document.createElement('button');
    div.className = "w-full text-left p-4 border-b border-gray-100 dark:border-gray-800 active:bg-gray-50 dark:active:bg-gray-900 transition-colors";
    div.innerHTML = `
      <div class="font-bold text-gray-800 dark:text-gray-100 truncate text-base mb-1">${escapeHtml(n.title||"Untitled")}</div>
      <div class="flex items-center justify-between text-xs text-gray-400">
        <span>${new Date(n.created_at).toLocaleDateString()}</span>
        ${n.files && n.files.length ? '<i class="fa-solid fa-paperclip"></i>' : ''}
      </div>
    `;
    div.onclick = () => loadNote(n.id);
    el.appendChild(div);
  });
}

/* --- FILES --- */
function renderFiles() {
  const el = document.getElementById('file-list'); el.innerHTML = "";
  const allFiles = [...(STATE.currentNote?.files||[]).map(f=>({...f, remote:true})), ...STATE.pendingFiles.map(f=>({...f, remote:false}))];
  
  document.getElementById('file-badge').classList.toggle('hidden', allFiles.length === 0);

  allFiles.forEach(f => {
    const d = document.createElement('div');
    d.className = `inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg border ${f.remote ? 'bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700' : 'bg-blue-50 border-blue-200 text-blue-700'}`;
    d.innerHTML = `<i class="fa-solid ${f.remote ? 'fa-file' : 'fa-upload'}"></i> <span class="max-w-[150px] truncate">${escapeHtml(f.filename)}</span>`;
    
    if(f.remote && STATE.isAdmin) {
      d.onclick = () => downloadFile(f);
      d.classList.add('cursor-pointer', 'active:scale-95');
    }
    el.appendChild(d);
  });
}

function handleFileSelect(inp) {
  Array.from(inp.files).forEach(async f => {
    const buf = await f.arrayBuffer();
    STATE.pendingFiles.push({filename:f.name, raw:buf});
    renderFiles();
  });
  inp.value="";
}

async function downloadFile(f) {
  try {
    showToast("Decrypting...", "info");
    const buf = await aesDecrypt(f.data, f.iv, STATE.currentNote._sessionKey, false);
    const url = URL.createObjectURL(new Blob([buf]));
    const a = document.createElement('a'); a.href=url; a.download=f.filename; a.click();
    URL.revokeObjectURL(url);
  } catch(e) { showToast("Download Failed", "error"); }
}

async function deleteNote() {
  if(!STATE.isAdmin || !STATE.currentNote) return;
  if(confirm("Delete note?")) {
    await fetch(`/api/notes/${STATE.currentNote.id}`, {method:'DELETE'});
    resetEditor(); refreshNotes(); goBack(); showToast("Deleted", "info");
  }
}

function resetEditor() {
  STATE.currentNote = null; STATE.pendingFiles = [];
  document.getElementById('note-title').value = "";
  document.getElementById('note-body').value = "";
  document.getElementById('status-text').innerText = "New Note";
  renderFiles();
}

/* --- UTILS --- */
function showToast(msg, type='info') {
  const d = document.createElement('div');
  const bg = type==='error'?'bg-red-500':type==='success'?'bg-green-600':'bg-gray-800';
  d.className = `${bg} text-white px-4 py-2.5 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 animate-bounce-in`;
  d.innerHTML = `<span>${msg}</span>`;
  document.getElementById('toast-container').appendChild(d);
  setTimeout(()=>d.remove(), 2500);
}
function toggleTheme() { document.documentElement.classList.toggle('dark'); }
function escapeHtml(s) { return s?s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):s; }

// Init dark mode pref
if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');

</script>
</body>
</html>


